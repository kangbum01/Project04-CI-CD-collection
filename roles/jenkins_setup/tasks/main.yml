#jenkins_setup-tasks-main.yml
# ì‚¬ìš©ë²•
# ansible-playbook -i hosts.ini install_Jenkins.yaml
# firefox http://ë³¸ì¸IP &
# ì‘ì—… ì „ì—ëŠ” ë¬´ì¡°ê±´ lbì„œë²„ì— jekins_deploy ë³´ë‚´ê¸°
---

####################################################################
# 0. ì‹œìŠ¤í…œ ê¸°ë³¸ ì„¤ì •
####################################################################
- name: "0-1. SELinux Permissive ì„¤ì • (ì»¨í…Œì´ë„ˆ ë§ˆìš´íŠ¸ ì•ˆì •í™”)"
  ansible.posix.selinux:
    policy: targeted
    state: permissive

- name: "0-2. Docker ì„œë¹„ìŠ¤ ì‹œì‘ ë° í™œì„±í™”"
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true

- name: "0-3. ACL ë„êµ¬ ì„¤ì¹˜ (Git repo ê¶Œí•œìš©)"
  ansible.builtin.package:
    name: acl
    state: present

####################################################################
# 1. Jenkins ê´€ë ¨ ë””ë ‰í† ë¦¬ ì¤€ë¹„ (UID 1000 ê¸°ì¤€)
####################################################################
- name: "1. Jenkins í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±"
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ jenkins_uid }}" # 1000
    group: "{{ target_gid }}"  # 1002
    mode: "{{ item.mode }}"
    recurse: no
  loop:
    - { path: "{{ jenkins_home }}/casc_configs", mode: "2775" }
    - { path: "{{ jenkins_home }}/init.groovy.d", mode: "2775" }
    - { path: "{{ base_dir }}/logs", mode: "2775" }
    - { path: "{{ git_dir }}", mode: "2775" }


####################################################################
# 2. Jenkins Deploy Key ì‚¬ì „ ê²€ì‚¬ (í‚¤ ìƒì„±/ì¬ë°œê¸‰ì€ ì ˆëŒ€ ì•ˆ í•¨)
#    ë‹¨, "ê¶Œí•œ/ì†Œìœ ê¶Œ êµì •"ì€ ìë™ìœ¼ë¡œ í•´ì¤€ë‹¤ (ë‚´ìš©ì€ ì•ˆ ê±´ë“œë¦¼)
####################################################################

- name: "2-0. Jenkins deploy key ì¡´ì¬ ì—¬ë¶€ í™•ì¸"
  ansible.builtin.stat:
    path: "{{ jenkins_home }}/.ssh/jenkins_deploy"
  register: jenkins_key

- name: "2-0b. Jenkins .ssh ë””ë ‰í† ë¦¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸"
  ansible.builtin.stat:
    path: "{{ jenkins_home }}/.ssh"
  register: jenkins_ssh_dir

- name: "2-1. Jenkins deploy key ì—†ìœ¼ë©´ ì¤‘ë‹¨(ìƒì„±ì€ ì ˆëŒ€ ì•ˆ í•¨)"
  ansible.builtin.fail:
    msg: >
      Jenkins deploy keyê°€ ì—†ìŠµë‹ˆë‹¤.
      ì´ playbookì€ SSH í‚¤ë¥¼ ìƒì„±/ìˆ˜ì •í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      ì‚¬ì „ì— {{ jenkins_home }}/.ssh/jenkins_deploy í‚¤ë¥¼ ìƒì„±í•˜ê³  LB ì„œë²„ì— ë°°í¬í•˜ì„¸ìš”.
  when: not jenkins_key.stat.exists

# âœ… ì—¬ê¸°ì„œë¶€í„°ëŠ” "ë‚´ìš©"ì´ ì•„ë‹ˆë¼ "ê¶Œí•œ"ë§Œ êµì •(ìë™ ë³µêµ¬)
- name: "2-2. Jenkins home ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ê¶Œí•œ ë³´ì¥"
  ansible.builtin.file:
    path: "{{ jenkins_home }}"
    state: directory
    owner: "{{ jenkins_uid }}"
    group: "{{ jenkins_uid }}"
    mode: "2775"

- name: "2-3. Jenkins deploy key ê¶Œí•œ êµì •(ë‚´ìš©ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)"
  block:
    - name: ".ssh ë””ë ‰í† ë¦¬ ê¶Œí•œ(0700)"
      ansible.builtin.file:
        path: "{{ jenkins_home }}/.ssh"
        state: directory
        owner: "{{ jenkins_uid }}"
        group: "{{ jenkins_uid }}"
        mode: "0700"

    - name: "jenkins_deploy ê¶Œí•œ(0600)"
      ansible.builtin.file:
        path: "{{ jenkins_home }}/.ssh/jenkins_deploy"
        state: file
        owner: "{{ jenkins_uid }}"
        group: "{{ jenkins_uid }}"
        mode: "0600"

    - name: "jenkins_deploy.pub ê¶Œí•œ(0644)"
      ansible.builtin.file:
        path: "{{ jenkins_home }}/.ssh/jenkins_deploy.pub"
        state: file
        owner: "{{ jenkins_uid }}"
        group: "{{ jenkins_uid }}"
        mode: "0644"
  when: jenkins_key.stat.exists

# âœ… êµì • í›„ ì¬ê²€ì¦(ì›ì¸ ì¶”ì ìš©)
- name: "2-4. (ì¬ê²€ì¦) Jenkins deploy key stat"
  ansible.builtin.stat:
    path: "{{ jenkins_home }}/.ssh/jenkins_deploy"
  register: jenkins_key_after

- name: "2-4b. (ì¬ê²€ì¦) Jenkins .ssh stat"
  ansible.builtin.stat:
    path: "{{ jenkins_home }}/.ssh"
  register: jenkins_ssh_dir_after

- name: "2-5. ìµœì¢… ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨"
  ansible.builtin.fail:
    msg: |
      Jenkins deploy key ê¶Œí•œ/ì†Œìœ ê¶Œ ìë™ êµì • í›„ì—ë„ ê²€ì¦ ì‹¤íŒ¨.

      - key exists: {{ jenkins_key_after.stat.exists }}
      - key mode  : {{ jenkins_key_after.stat.mode | default('N/A') }}
      - key uid   : {{ jenkins_key_after.stat.uid  | default('N/A') }}
      - .ssh mode : {{ jenkins_ssh_dir_after.stat.mode | default('N/A') }}
      - .ssh uid  : {{ jenkins_ssh_dir_after.stat.uid  | default('N/A') }}

      ê¸°ëŒ€ê°’:
      - {{ jenkins_home }}/.ssh                 : owner UID={{ jenkins_uid }}, mode=0700
      - {{ jenkins_home }}/.ssh/jenkins_deploy  : owner UID={{ jenkins_uid }}, mode=0600
  when: >
    (not jenkins_key_after.stat.exists) or
    (jenkins_key_after.stat.mode is defined and jenkins_key_after.stat.mode != "0600") or
    (jenkins_key_after.stat.uid  is defined and (jenkins_key_after.stat.uid | string) != (jenkins_uid | string)) or
    (jenkins_ssh_dir_after.stat.mode is defined and jenkins_ssh_dir_after.stat.mode != "0700") or
    (jenkins_ssh_dir_after.stat.uid  is defined and (jenkins_ssh_dir_after.stat.uid | string) != (jenkins_uid | string))


# ==============================================================================
# 3. ì  í‚¨ìŠ¤ ì´ˆê¸° ê¸°ë™ ì„¤ì •
# ==============================================================================

# 3. Jenkins ì´ˆê¸° ì„¤ì •
- name: "Groovy í† í° ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ë°°ì¹˜"
  template:
    src: generate-token.groovy.j2
    dest: "{{ jenkins_home }}/init.groovy.d/generate-token.groovy"
    owner: "1000"
    mode: "0664"

- name: "ì„ì‹œ CasC ë°°ì¹˜"
  copy:
    content: "jenkins: {}"
    dest: "{{ jenkins_home }}/casc_configs/jenkins.yaml"
    owner: "1000"
    mode: "0664"

- name: "Jenkins ì»¤ìŠ¤í…€ ì´ë¯¸ì§€ ë¹Œë“œ (custom-jenkins:latest)"
  community.docker.docker_image:
    name: custom-jenkins
    tag: latest
    source: build
    build:
      path: "{{ custom_jenkins_build_path }}"
      pull: true
  register: build_result

- name: "Jenkins ì»¨í…Œì´ë„ˆ ê¸°ë™"
  community.docker.docker_container:
    name: jenkins-server
    image: custom-jenkins:latest
    state: started
    restart_policy: always
    ports:
      - "8080:8080"
    env:
      CASC_JENKINS_CONFIG: "/var/jenkins_home/casc_configs/jenkins.yaml"
      JENKINS_ADMIN_ID: "{{ admin_id }}"
      JENKINS_ADMIN_PW: "{{ admin_pw }}"
      JAVA_OPTS: "-Djenkins.install.runSetupWizard=false -Dhudson.plugins.git.GitSCM.ALLOW_LOCAL_CHECKOUT=true"
    volumes:
      - "{{ jenkins_home }}:/var/jenkins_home:Z"
      - "/home/ansible-admin/project:/home/ansible-admin/project:Z"

- name: "API í† í° ìƒì„± ëŒ€ê¸°"
  wait_for:
    path: "{{ jenkins_home }}/api_token.txt"
    timeout: 60

- name: "API í† í° slurp"
  slurp:
    src: "{{ jenkins_home }}/api_token.txt"
  register: token_raw

- name: "ìµœì¢… Jenkins CasC ë°˜ì˜"
  template:
    src: jenkins.yaml.j2
    dest: "{{ jenkins_home }}/casc_configs/jenkins.yaml"
    owner: "{{ jenkins_uid }}"
    mode: "0664"

- name: "Jenkins ì¬ì‹œì‘"
  community.docker.docker_container:
    name: jenkins-server
    state: started
    restart: true

# âœ… Git safe.directory ì„¤ì • (system) - dubious ownership ë°©ì§€
# - ì—¬ëŸ¬ ì‚¬ìš©ì/UID(ì  í‚¨ìŠ¤/AI/ê´€ë¦¬ì)ê°€ ê°™ì€ bare repoë¥¼ ë§Œì ¸ë„ ì•ˆì „ ì²˜ë¦¬ë˜ë„ë¡
- name: "5-1b. Git safe.directory ëª©ë¡ ì¡°íšŒ (system)"
  become: true
  ansible.builtin.command: git config --system --get-all safe.directory
  register: safe_dirs
  changed_when: false
  failed_when: false  # ì•„ì§ ì„¤ì •ì´ ì—†ìœ¼ë©´ rc!=0 ê°€ëŠ¥í•˜ë¯€ë¡œ ë¬´ì‹œ

- name: "5-1c. Git safe.directoryì— bare repo ê²½ë¡œ ì¶”ê°€ (system)"
  become: true
  ansible.builtin.command: git config --system --add safe.directory "*"
  when: safe_dirs.stdout is not defined or (git_dir not in safe_dirs.stdout_lines | default([]))

- name: "5-1d. Git safe.directory ìµœì¢… í™•ì¸ (system)"
  become: true
  ansible.builtin.command: git config --system --get-all safe.directory
  register: safe_dirs_after
  changed_when: false

# âœ… (ì„ íƒ) ë””ë²„ê·¸ë¡œ ì‹¤ì œ ë“±ë¡ í™•ì¸í•˜ê³  ì‹¶ìœ¼ë©´ ì£¼ì„ í•´ì œ
- name: "DEBUG safe.directory"
  ansible.builtin.debug:
    var: safe_dirs_after.stdout_lines

- name: "5-2. Git ì €ì¥ì†Œ ACL ì„¤ì •"
  ansible.posix.acl:
    path: "{{ git_dir }}"
    entity: "{{ item.id }}"
    etype: "{{ item.type }}"
    permissions: rwx
    recursive: yes
    default: yes
    state: present
  loop:
    - { id: "1000", type: "user" }            # Jenkins
    - { id: "{{ target_gid }}", type: "group" } # AI / ê´€ë¦¬ì ê·¸ë£¹

- name: "5-3. Git ê³µìœ  ì •ì±… ì„¤ì •"
  ansible.builtin.shell: |
    git config --file {{ git_dir }}/config core.sharedRepository group
    git config --file {{ git_dir }}/config receive.denyNonFastForwards false

- name: "5-4. post-receive hook ë°°í¬"
  ansible.builtin.template:
    src: post-receive.j2
    dest: "{{ git_dir }}/hooks/post-receive"
    owner: "{{ jenkins_uid }}"
    group: "{{ target_gid }}"
    mode: "0755"


####################################################################
# 7. ê²°ê³¼ ì¶œë ¥ ë° ë¯¼ê° ì •ë³´ ì •ë¦¬
####################################################################
- name: "7-1. Jenkins ì •ë³´ ì¶œë ¥"
  ansible.builtin.debug:
    msg:
      - "ğŸš€ Jenkins CI/CD ì„œë²„ êµ¬ì¶• ì™„ë£Œ"
      - "URL: http://{{ ansible_host }}:8080"
      - "Job Name: {{ jenkins_job_name }}"

- name: "7-2. API í† í° íŒŒì¼ ì œê±°"
  ansible.builtin.file:
    path: "{{ jenkins_home }}/api_token.txt"
    state: absent
