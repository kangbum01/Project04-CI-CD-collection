#jenkins_setup-tasks-main.yml
# ì‚¬ìš©ë²•
# ansible-playbook -i hosts.ini install_Jenkins.yaml
# firefox http://ë³¸ì¸IP &

---
- name: "0. ì‹œìŠ¤í…œ ê¸°ë³¸ ì„¤ì • ë° ë„ì»¤ ì¤€ë¹„"
  block:
    - name: "0-1. SELinuxë¥¼ Permissive ëª¨ë“œë¡œ ë³€ê²½ (ë””ë²„ê¹… ë° ë§ˆìš´íŠ¸ ì›í™œí™”)"
      ansible.posix.selinux:
        policy: targeted
        state: permissive
      become: yes  # root ê¶Œí•œ í•„ìš”
      
    # 0. ë„ì»¤ ì„œë¹„ìŠ¤ ê¸°ë™
    - name: "0-2. ë„ì»¤ ì„œë¹„ìŠ¤ ì‹œì‘ ë° í™œì„±í™”"
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true
    
    - name: "0-3. ACL ê´€ë¦¬ ë„êµ¬ ì„¤ì¹˜"
      ansible.builtin.package:
        name: acl
        state: present
  become: true

# ==============================================================================
# 1. í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ë¶€ì—¬
# ==============================================================================
# 1. ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì • (í•µì‹¬: ì  í‚¨ìŠ¤ UID 1000 ì ìš©)
- name: "1. í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„±"
  ansible.builtin.file:
    path: "{{ item.path }}" # itemì€ loopë¬¸ì— ì‚¬ìš©ë˜ëŠ” ë³€ìˆ˜ì…ë‹ˆë‹¤.
    state: directory
    owner: "1000"
    group: "{{ target_gid }}"
    mode: "{{ item.mode }}" # 2ëŠ” setgid ë¹„íŠ¸ë¡œ ë¶€ëª¨ ë””ë ‰í† ë¦¬ ê·¸ë£¹ì„ ìƒì†
    recurse: yes
  loop:
    - { path: "{{ jenkins_home }}/casc_configs", mode: '2775' }
    - { path: "{{ jenkins_home }}/init.groovy.d", mode: '2775' }
    - { path: "{{ base_dir }}/logs", mode: '2775' } # ì˜¤ë¥˜ logê°€ ì €ì¥ ë  í´ë”
    - { path: "{{ git_dir }}", mode: '2775' } # git í´ë” ë¯¸ë¦¬ ìƒì„±

# ==============================================================================
# 2. í‚¤ ê´€ë ¨ íŒŒíŠ¸ (SSH & Security Hardening)
# ==============================================================================
- name: "2. SSH í‚¤ ê¶Œí•œ ì •ë¦½ (FACL í™œìš©)"
  block:
    - name: "2-1. í˜¸ìŠ¤íŠ¸ SSH í´ë” ë° í‚¤ ê¶Œí•œ ì„¤ì •(0600)"
      ansible.builtin.file:
        path: "/home/ansible-admin/.ssh/{{ item.path }}"
        owner: "1000"
        group: "1000"
        mode: "{{ item.mode }}"
        state: "{{ item.state }}"
      loop:
        - { path: "", mode: "0700", state: "directory" }
        - { path: "id_rsa", mode: "0600", state: "file" }
  become: true
  # - name: "2-2. Jenkins(1000)ì—ê²Œ SSH í‚¤ ì½ê¸° ê¶Œí•œë§Œ ë¶€ì—¬"
  #   ansible.posix.acl:
  #     path: "/home/ansible-admin/.ssh/id_rsa"
  #     entity: "1000"
  #     etype: user
  #     permissions: r
  #     state: present
# ==============================================================================
# 3. ì  í‚¨ìŠ¤ ì´ˆê¸° ê¸°ë™ ì„¤ì •
# ==============================================================================

- name: "3. ì  í‚¨ìŠ¤ ì´ˆê¸° ê¸°ë™ ì„¤ì •"
  block:
    - name: "3-1. í† í° ìƒì„±ìš© Groovy ìŠ¤í¬ë¦½íŠ¸ ë°°ì¹˜"
      ansible.builtin.template:
        src: 'generate-token.groovy.j2'
        dest: "{{ jenkins_home }}/init.groovy.d/generate-token.groovy"
        owner: "1000"
        mode: '0664'

    - name: "3-2. ë¶€íŒ… ì—ëŸ¬ ë°©ì§€ìš© ì´ˆê¸° jenkins.yaml ë°°ì¹˜"
      ansible.builtin.copy:
        content: "jenkins: {}" # ìµœì†Œí•œì˜ ë°ì´í„°ë§Œ ë„£ìŠµë‹ˆë‹¤.
        dest: "{{ jenkins_home }}/casc_configs/jenkins.yaml"
        owner: "1000"
        mode: '0664'

    - name: "3-3. ì  í‚¨ìŠ¤ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
      community.docker.docker_container:
        name: jenkins-server
        image: custom-jenkins:latest
        state: started
        restart_policy: always
        ports:
          - "8080:8080"
          - "50000:50000"
        env:
          CASC_JENKINS_CONFIG: "/var/jenkins_home/casc_configs/jenkins.yaml"
          JENKINS_ADMIN_ID: "{{ admin_id }}"
          JENKINS_ADMIN_PW: "{{ admin_pw }}"
          JAVA_OPTS: "-Djenkins.install.runSetupWizard=false -Dhudson.plugins.git.GitSCM.ALLOW_LOCAL_CHECKOUT=true"
        volumes:
          - "{{ jenkins_home }}:/var/jenkins_home:Z"
          # [í•µì‹¬] í˜¸ìŠ¤íŠ¸ì˜ ì›ë³¸ ê²½ë¡œë¥¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ê²½ë¡œë¡œ ì§ì ‘ ë§¤í•‘
          - "/home/ansible-admin/.ssh/id_rsa:/var/jenkins_home/.ssh/id_rsa:ro,Z"
          - "/home/ansible-admin/project:/home/ansible-admin/project:Z"
      become: true

# ==============================================================================
# 4. ìµœì¢… ì„¤ì • ì—…ë°ì´íŠ¸
# ==============================================================================
- name: "4. ìµœì¢… ì„¤ì • ì—…ë°ì´íŠ¸"
  block:
    - name: "4-1. í† í° íŒŒì¼ ìƒì„± ëŒ€ê¸°"
      ansible.builtin.wait_for:
        path: "{{ jenkins_home }}/api_token.txt"
        timeout: 60

    - name: "4-2. í† í° ê°’ ë³€ìˆ˜ ë“±ë¡ (slurp)"
      ansible.builtin.slurp:
        src: "{{ jenkins_home }}/api_token.txt"
      register: token_raw

    - name: "4-3. í™•ë³´ëœ í† í°ì„ í¬í•¨í•˜ì—¬ jenkins.yaml ë°°í¬"
      ansible.builtin.template:
        src: 'jenkins.yaml.j2'
        dest: "{{ jenkins_home }}/casc_configs/jenkins.yaml"
        owner: "1000"
        mode: '0664'

    - name: "4-4. ì„¤ì • ë°˜ì˜ì„ ìœ„í•œ ì  í‚¨ìŠ¤ ì¬ì‹œì‘"
      community.docker.docker_container:
        name: jenkins-server
        state: started
        restart: true
  become: true

# ==============================================================================
# 5. Git ì €ì§•ì†Œ ë° post-receive ì„¤ì •
# ==============================================================================
- name: "5. Git ì €ì¥ì†Œ ë° post-receive ì„¤ì •"
  block:
    - name: "5-1. Git Bare ì €ì¥ì†Œ ìƒì„± ë° ì´ˆê¸°í™”"
      ansible.builtin.shell: |
        mkdir -p {{ git_dir }}
        if [ ! -d "{{ git_dir }}/objects" ]; then
          git init --bare --shared=group {{ git_dir }}
        fi
      args:
        executable: /bin/bash

    - name: "5-2. Git ì €ì¥ì†Œ FACL ê¶Œí•œ ë¶€ì—¬ (í‘œ ê¸°ì¤€ rwx ë°˜ì˜)"
      ansible.posix.acl:
        path: "{{ git_dir }}"
        entity: "{{ item.id }}"
        etype: "{{ item.type }}"
        permissions: rwx # í‘œ ê¸°ì¤€: ì½”ë“œ í‘¸ì‹œ ë° í›… ì‹¤í–‰ì„ ìœ„í•œ rwx ì ìš©
        state: present
        recursive: yes
        default: yes      # í–¥í›„ ìƒì„±ë˜ëŠ” ì»¤ë°‹ íŒŒì¼ì—ë„ rwx ê¶Œí•œ ìë™ ìƒì†
      loop:
        - { id: "1000", type: "user" }          # ì  í‚¨ìŠ¤ ì»¨í…Œì´ë„ˆ ìœ ì €
        - { id: "{{ target_gid }}", type: "group" } # ê´€ë¦¬ì ë° AI ì„œë²„ ê·¸ë£¹

    - name: "5-3. Git ì €ì¥ì†Œ ê³µìœ  ë° í‘¸ì‹œ ì •ì±… ì„¤ì •"
      ansible.builtin.shell: |
        # ê·¸ë£¹ ë‚´ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ìƒì„±í•œ ì˜¤ë¸Œì íŠ¸ì— ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
        git config --file {{ git_dir }}/config core.sharedRepository group
        # ê°•ì œ í‘¸ì‹œ í—ˆìš© (CI/CD íŒŒì´í”„ë¼ì¸ì˜ ìœ ì—°í•œ ë°°í¬ ëª©ì )
        git config --file {{ git_dir }}/config receive.denyNonFastForwards false

    - name: "5-4. Git post-receive í›… ë°°í¬"
      ansible.builtin.template:
        src: "post-receive.j2"
        dest: "{{ git_dir }}/hooks/post-receive"
        owner: "1000"       # ì  í‚¨ìŠ¤ê°€ ì‹¤í–‰ ì£¼ì²´ì´ë¯€ë¡œ 1000 ë¶€ì—¬
        group: "{{ target_gid }}"
        mode: '0755'        # ì‹¤í–‰ ê¶Œí•œ í•„ìˆ˜
  become: true

- name: "6. ìµœì¢… ê²°ê³¼ ì¶œë ¥"
  ansible.builtin.debug:
    msg: 
      - "ğŸš€ ì  í‚¨ìŠ¤ ìë™í™” ì„¸íŒ… ì™„ë£Œ!"
      - "URL: http://{{ ansible_host }}:8080"
      - "Job Name: {{ jenkins_job_name }}"
      - "Token: {{ token_raw['content'] | b64decode }}"

- name: "7. ë³´ì•ˆì„ ìœ„í•œ token ì œê±°"
  ansible.builtin.file:
    path: "{{ jenkins_home }}/api_token.txt"
    state: absent
  become: true
