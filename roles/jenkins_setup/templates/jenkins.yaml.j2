# roles/jenkins_setup/templates/jenkins.yaml.j2
jenkins:
  securityRealm:
    local:
      allowsSignup: false
      users:
        - id: "{{ admin_id }}"
          password: "{{ admin_pw }}"
  authorizationStrategy:
    loggedInUsersCanDoAnything:
      allowAnonymousRead: false

  globalNodeProperties:
    - envVars:
        env:
          - key: "ansible"
            value: "{{ ansible_bin_path }}"
          - key: "PYTHONPATH"
            value: "{{ python_path }}"
          - key: "ANSIBLE_HOST_KEY_CHECKING"
            value: "False"

unclassified:
  location:
    url: "http://{{ ansible_host }}:8080/"

jobs:
  - script: |
      pipelineJob('{{ jenkins_job_name }}') {
        // [1] Ïù∏Ï¶ù ÌÜ†ÌÅ∞ ÏÑ§Ï†ï
        authenticationToken('{{ token_raw['content'] | b64decode | trim }}')
        
        definition {
          cps {
            // Ïô∏Î∂ÄÎ•º """Î°ú Í∞êÏã∏Í≥† ÎÇ¥Î∂ÄÏùò $Îäî \$Î°ú Ïù¥Ïä§ÏºÄÏù¥ÌîÑÌïòÏó¨ Ï∂©Îèå Î∞©ÏßÄ
            script(""" 
              pipeline {
                agent any
                stages {
                  stage('Checkout') {
                    steps {
                      sh "git config --global --add safe.directory '*'"
                      git branch: 'main', url: 'file:///home/ansible-admin/project/git/music-project.git'
                    }
                  }
                  stage('Deploy to Web Server') {
                    steps {
                      sh '''
                        set -euo pipefail
                        REPO="/home/ansible-admin/project/Project04-CI-CD-collection"

                        echo "[DEBUG] PWD=\$(pwd)"
                        echo "[DEBUG] WORKSPACE=\$WORKSPACE"
                        echo "[DEBUG] REPO=\$REPO"

                        export ANSIBLE_HOST_KEY_CHECKING=False
                        export ANSIBLE_PRIVATE_KEY_FILE="/var/jenkins_home/.ssh/jenkins_deploy"
                        export ANSIBLE_SSH_ARGS="-o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ControlMaster=no -o ControlPersist=no"

                        ansible-playbook -i "\$REPO/inventory/hosts.ini" "\$REPO/web_deploy.yml" \\
                                         -e "src_path=\$WORKSPACE/web/" \\
                                         | tee ansible_output.log
                      '''
                    }
                  }
                }
                post {
                  success { 
                    echo 'üéâ Î∞∞Ìè¨ ÏÑ±Í≥µ!' 
                  }
                  failure {
                    sh '''
                      if [ -f ansible_output.log ]; then
                        cp ansible_output.log /home/ansible-admin/project/logs/deploy_error.log
                      fi
                    '''
                  }
                  always {
                    echo "ÎπåÎìú ÏôÑÎ£å"
                  }
                }
              }
            """.stripIndent())
            sandbox(true)
          }
        }
      }
      