# ==============================================================================
# [ 가이드 및 체크리스트 ]
# 1. Ansible playbook은 한번씩만 실행하시고
# 2. 이후 git에 올릴때는 git add . , git commit -m , git push 로 올리시면 됩니다.
# 3. 실행 방법: ansible-playbook -i (hosts.ini 위치) (파일위치)
#
# [ AI -> CI/CD 확인 방법 ]
# 1. music-project.git 폴더로 이동
# 2. git log main 으로 log 확인
# 3. git show main:result.txt로 내용 확인 가능
# 4. git ls-tree -rt 60c596beae4c07cd2954fe415065e48919a1f6bb
# 5. git show 60c596beae4c07cd2954fe415065e48919a1f6bb:web/theme.json
# ==============================================================================

---
# 0. 초기 작업: git 설치
- name: "0. Install Git package"
  ansible.builtin.dnf:
    name: git
    state: present
  become: true

# # 1. 권한 구조 일괄 정리 (범석님 제안 핵심 반영)
# # 작업 시작 전 소유권을 확실히 잡아 이후 에러를 원천 차단합니다.
# - name: "1. AI 서버 소유권 및 그룹 설정 (젠킨스 사용)"
#   ansible.builtin.file:
#     path: "{{ project_dir }}"
#     owner: "{{ user_name }}"
#     group: "{{ target_gid | default('1002') }}"
#     state: directory
#     recurse: yes
#     mode: '2775'
#   become: true

# 1. 권한 구조 일괄 정리 (범석님 제안: 입구부터 데이터까지 싹 다 개방)
- name: "1. 서버 진입 및 프로젝트 폴더 권한 일괄 개방"
  block:
    - name: "1-1. 홈 디렉토리 진입 권한 부여 (755)"
      ansible.builtin.file:
        path: "{{ deploy_root }}"
        state: directory
        mode: '0755'  # 외부 유저나 컨테이너가 이 폴더를 '통과'할 수 있게 함

    - name: "1-2. 프로젝트 폴더 소유권 및 권한 강제 설정 (777)"
      ansible.builtin.file:
        path: "{{ item }}"
        owner: "{{ user_name }}"
        group: "{{ target_gid | default('1002') }}"
        state: directory
        # 2777: 777로 다 열되, 상위 그룹 권한을 하위 파일들이 그대로 이어받게 함(setgid)
        mode: '2777' 
      loop:
        - "{{ project_dir }}"
        - "{{ git_dir | default('/home/ansible-admin/project/git') }}" # Git 저장소 경로가 있다면 포함
  become: true
      
# 2. Git 환경 설정
- name: "2. Configure Git User & Environment"
  block:
    - name: "2-1. Set Git Global Config"
      community.general.git_config:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        scope: global
      loop:
        - { name: 'user.name', value: "{{ ansible_hostname }}" }
        - { name: 'user.email', value: '{{ git_user_email }}' }
        - { name: 'init.defaultBranch', value: 'main' }
        - { name: 'safe.directory', value: '*' }
  become: false

# 3. 프로젝트 폴더 이동 및 Git 초기화
- name: "3. Initialize Git Repository"
  ansible.builtin.shell: |
    git init
    git branch -M main
  args:
    chdir: "{{ project_dir }}"
    creates: "{{ project_dir }}/.git"
  become: false

# 4. 원격 저장소 등록 및 푸시
- name: "4. Remote 등록 및 Push"
  ansible.builtin.shell: |
    # origin이 이미 있으면 주소만 업데이트, 없으면 생성
    git config --global --add safe.directory {{ project_dir }} || true

    git remote set-url origin ansible-admin@{{ git_server_ip }}:{{ git_dir }} || \
    git remote add origin ansible-admin@{{ git_server_ip }}:{{ git_dir }}

    export GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no"
    git add .
    git commit -m "AI Analysis Result: {{ ansible_date_time.iso8601 }}" || true
    git push -u -f origin main
  args:
    chdir: "{{ project_dir }}"
    executable: /bin/bash
  become: false

# ==============================================================================
# [ 트러블슈팅 및 히스토리 기록 섹션 ]
# ==============================================================================
# 1. 유저 설정 관련 (Task 2)
# - root권한이 아닌 ansible-admin으로 설정한 이유는 작업 시 ansible-admin으로 작업하는데 
#   user.name이랑 email을 root의 config로 설정하면 ansible-admin으로 작업을 진행할려고 할 때 
#   config 설정이 된 게 없어서 오류가 발생하기 때문입니다.
#
# 2. 무한 대기 및 접속 권한 문제 (Task 4)
# - 원격 저장소 등록(30.0.1.11) 시 무한 대기가 발생했었음.
# - [12/24 해결]: 관리자로 만들었는데 ansible-admin으로 접속해서 발생한 문제였음. 
#   현재는 ansible-admin 계정으로 통일하여 해결 완료.
#
# 3. 소유권 변경의 중요성 (Task 1)
# - 범석님이 제안하신 핵심 내용으로, 하위 폴더(.git 포함)까지 싹 다 ansible-admin으로 
#   바꿔주어야 이후 git 명령어 실행 시 Permission 에러가 발생하지 않음.
# ==============================================================================
