---
- name: "Step 1: Prepare Ansible Control Node Environment"
  hosts: localhost
  connection: local
  become: false 
  tasks:
    - name: "1-0. 도커 설치 방해 요소 제거 (Podman 비활성화)"
      block:
        - name: "1-0-1. Podman 관련 서비스 정지 및 마스킹"
          ansible.builtin.systemd:
            name: "{{ item }}"
            state: stopped
            enabled: false
            masked: true
          loop:
            - podman.socket
            - podman.service
          ignore_errors: true

        - name: "1-0-2. 도커 명령어 경로 충돌 패키지 제거"
          ansible.builtin.package:
            name: podman-docker
            state: absent
      become: true

    - name: "1-1. Docker 엔진 및 필수 패키지 설치"
      block:
        - name: "1-1-1. yum-utils 설치 및 리포지토리 추가"
          ansible.builtin.package:
            name: yum-utils
            state: present

        - name: "1-1-2. Docker 공식 리포지토리 추가"
          ansible.builtin.get_url:
            url: https://download.docker.com/linux/centos/docker-ce.repo
            dest: /etc/yum.repos.d/docker-ce.repo
            mode: '0644'

        - name: "1-1-3. Docker CE 및 SDK 설치"
          ansible.builtin.package:
            name: ["docker-ce", "docker-ce-cli", "containerd.io", "python3-pip"]
            state: present

        - name: "1-1-4. pip로 Docker SDK 설치"
          ansible.builtin.pip:
            name: docker
            state: present
      become: true

    - name: "1-2. Ansible 컬렉션 준비"
      block:
        - name: "1-2-1. ansible-galaxy 명령어 위치 찾기"
          ansible.builtin.command: which ansible-galaxy
          register: found_galaxy
          changed_when: false

        - name: "1-2-2. 필수 컬렉션 설치( Docker & General )"
          ansible.builtin.command: 
            cmd: "{{ found_galaxy.stdout | default('ansible-galaxy') }} collection install {{ item }}"
          loop:
            - community.docker
            - community.general
          register: res
          changed_when: "'nothing to do' not in res.stdout"

- name: "Step 2: Execute Jenkins Automation"
  hosts: localhost
  become: true
  tasks:
    - name: "Jenkins 역할 로드"
      ansible.builtin.include_role:
        name: jenkins_setup
      tags: jenkins-setup

- name: "Step 3: Execute AI Automation"
  hosts: AI_Server
  become: true
  tasks:
    - name: "AI 서버 및 Git 연결 역할 로드"
      ansible.builtin.include_role:
        name: ai_analysis
      tags: ai-server

# ==============================================================================
# [ HISTORY & TROUBLESHOOTING ]
# ==============================================================================
# 1. Podman 관련 충돌 (Step 1-0)
#    - RHEL/CentOS 계열에서는 Podman이 기본 설치되어 있어 '진짜 도커'와 충돌함.
#    - 특히 podman-docker 패키지가 있으면 docker 명령어가 Podman으로 에일리어싱되어 
#      설치가 실패하므로 반드시 제거(absent) 및 마스킹(masked) 처리해야 함.
#
# 2. Docker SDK 설치
#    - 앤서블의 community.docker 컬렉션을 쓰려면 파이썬의 docker 라이브러리가 필수임.
#
# 3. 필수 컬렉션 설치
# community.docker: docker_container, docker_image 등 도커 관련 작업을 할 때 필요합니다. (Step 2 젠킨스 작업 시 사용)
# community.general: git_config, systemd, slack 알림 등 도커 외의 일반적인 리눅스 환경 및 커뮤니티 모듈들을 포함합니다. (Step 3 AI 서버의 Git 설정 시 사용)
# ==============================================================================